<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>Login - Meridien Calendar</title>
    <link rel="stylesheet" href="/assets/styles.css" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  </head>
  <body>
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <h1 class="login-title">Welcome Back</h1>
          <p class="login-subtitle">Sign in to access your calendar</p>
        </div>

        <form class="login-form" id="loginForm">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="Enter your email"
              required
              autocomplete="email"
            />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              placeholder="Enter your password"
              required
              autocomplete="current-password"
            />
          </div>

          <button type="submit" class="login-button btn" id="loginButton">
            Sign In
          </button>
        </form>

        <!-- Error message display -->
        <div
          class="error-message"
          id="errorMessage"
          style="display: none"
        ></div>
      </div>
    </div>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDAaZo9T9CVa2yTC-t6_WL4Ljy-Uce_IeE",
        authDomain: "meridien-cal.firebaseapp.com",
        databaseURL:
          "https://meridien-cal-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "meridien-cal",
        storageBucket: "meridien-cal.firebasestorage.app",
        messagingSenderId: "872918390831",
        appId: "1:872918390831:web:f262c134a3f14ee50d0eda",
        measurementId: "G-TQ3SDN7CF6"
      }

      // Initialize Firebase with error handling
      try {
        firebase.initializeApp(firebaseConfig)
      } catch (error) {
        console.error("Firebase initialization error:", error)
        showError("Firebase configuration error. Please contact support.")
      }
      const auth = firebase.auth()

      // DOM elements
      const loginForm = document.getElementById("loginForm")
      const emailInput = document.getElementById("email")
      const passwordInput = document.getElementById("password")
      const loginButton = document.getElementById("loginButton")
      const errorMessage = document.getElementById("errorMessage")

      // Helper function to set secure cookie
      function setAuthCookie(token) {
        document.cookie = `firebaseToken=${encodeURIComponent(
          token
        )}; path=/; max-age=3600; samesite=strict`
        localStorage.setItem("firebaseToken", token)
      }

      // Check if user is already logged in
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          try {
            // Get the ID token to verify authentication is working
            const idToken = await user.getIdToken()
            setAuthCookie(idToken)

            // Add a small delay to prevent rapid redirects
            setTimeout(() => {
              window.location.href = "/events"
            }, 100)
          } catch (error) {
            console.error("Error getting auth token:", error)
            // If there's an error getting the token, stay on login page
            showError("Authentication error. Please try logging in again.")
          }
        }
      })

      // Login form submission
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault()

        const email = emailInput.value.trim()
        const password = passwordInput.value

        if (!email || !password) {
          showError("Please fill in all fields")
          return
        }

        // Show loading state
        setLoading(true)
        hideError()

        try {
          // Sign in with Firebase
          const userCredential = await auth.signInWithEmailAndPassword(
            email,
            password
          )
          const user = userCredential.user

          // Get the ID token to send to backend
          const idToken = await user.getIdToken()

          // Store token in both localStorage and cookie
          setAuthCookie(idToken)

          // Redirect to events page
          window.location.href = "/events"
        } catch (error) {
          console.error("Login error:", error)

          // Handle Firebase errors with simple messages
          let errorMsg = "Login failed. Please try again"

          switch (error.code) {
            case "auth/user-not-found":
              errorMsg = "No account found with this email"
              break
            case "auth/wrong-password":
              errorMsg = "Incorrect password"
              break
            case "auth/invalid-credential":
              errorMsg = "Invalid email or password"
              break
            case "auth/invalid-email":
              errorMsg = "Invalid email address"
              break
            case "auth/user-disabled":
              errorMsg = "Account disabled"
              break
            case "auth/too-many-requests":
              errorMsg = "Too many attempts. Try again later"
              break
            case "auth/network-request-failed":
              errorMsg = "Connection error. Check your internet"
              break
            case "auth/api-key-not-valid":
            case "auth/app-deleted":
            case "auth/invalid-api-key":
              errorMsg = "Service error. Contact support"
              break
            default:
              // For any unhandled errors, show the actual Firebase error message if available
              errorMsg = error.message || "Login failed. Please try again"
          }

          showError(errorMsg)
        } finally {
          setLoading(false)
        }
      })

      // Helper functions
      function setLoading(loading) {
        if (loading) {
          loginButton.disabled = true
          loginButton.classList.add("loading")
        } else {
          loginButton.disabled = false
          loginButton.classList.remove("loading")
        }
      }

      function showError(message) {
        errorMessage.textContent = message
        errorMessage.style.display = "block"
      }

      function hideError() {
        errorMessage.style.display = "none"
      }
    </script>
  </body>
</html>
