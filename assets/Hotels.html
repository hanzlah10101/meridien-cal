<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>Mobile Calendar</title>
    <style>
      :root {
        --bg: #0f172a; /* slate-900 */
        --card: #111827; /* gray-900 */
        --muted: #94a3b8; /* slate-400 */
        --text: #f1f1f1; /* brighter text-200 */
        --accent: #b8860b; /* dark gold */
        --accent-dark: #b8860b; /* dark gold */
        --danger: #ef4444; /* red */
        --ring: rgba(212, 175, 55, 0.45);
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --radius: 18px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans,
          Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        background: radial-gradient(
          1000px 600px at 50% -10%,
          #1f2937 0%,
          var(--bg) 50%
        );
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .app {
        width: 100%;
        max-width: 480px;
        height: 100svh;
        max-height: 860px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .title {
        display: flex;
        align-items: baseline;
        gap: 8px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .title .month {
        font-size: clamp(18px, 4vw, 24px);
        color: var(--accent);
        cursor: pointer;
        transition: 0.2s color;
      }
      .title .month:hover {
        color: var(--accent-dark);
        opacity: 0.8;
      }
      .title .year {
        font-size: clamp(14px, 3.3vw, 16px);
        color: var(--muted);
        background: transparent;
        border: none;
        outline: none;
        cursor: pointer;
        font-family: inherit;
        font-weight: inherit;
        padding: 0;
        margin: 0;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0 center;
        background-size: 16px;
        padding-right: 20px;
      }
      .title .year:hover {
        color: var(--accent);
      }
      .title .year:focus {
        color: var(--accent);
      }

      .btn {
        appearance: none;
        border: 1px solid transparent;
        background: #1a1a1a;
        color: var(--text);
        padding: 10px 12px;
        border-radius: 14px;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: 0.2s transform, 0.2s background, 0.2s border-color;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        display: flex;
        justify-content: center;
        text-align: center;
        align-items: center;
      }
      .btn:hover {
        transform: translateY(-1px);
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn.icon {
        padding: 10px;
        border-radius: 14px;
      }
      .btn.secondary {
        background: transparent;
        border-color: #263247;
      }
      .btn.accent {
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        border: none;
        color: #000;
        font-weight: 700;
      }

      .calendar {
        background: #0b1220;
        border: 1px solid #1f2937;
        border-radius: var(--radius);
        padding: 12px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 1;
        min-height: 0;
      }

      .weekdays,
      .grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
      }
      .weekdays div {
        text-align: center;
        color: var(--accent);
        font-size: 12px;
        letter-spacing: 0.4px;
      }

      .cell {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 14px;
        aspect-ratio: 1/1.05;
        padding: 8px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 6px;
        transition: 0.2s border-color, 0.2s transform;
        color: #f8f8f8;
      }
      .cell.faded {
        opacity: 0.35;
        color: aaa;
      }
      .cell.today {
        border-color: var(--accent);
        box-shadow: inset 0 0 0 2px var(--ring);
      }
      .cell .date {
        font-weight: 700;
        font-size: 14px;
        color: var(--accent);
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .cell .hijri {
        font-size: 10px !important;
        color: var(--muted) !important;
      }
      .cell .events {
        margin-top: auto;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .pill {
        font-size: 10px;
        padding: 4px 6px;
        border-radius: 999px;
        background: #172036;
        border: 1px solid #263247;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        max-width: 100%;
      }

      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
      }
      .nav {
        display: flex;
        gap: 6px;
      }
      .footer {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
      }

      /* Bottom Sheet - Optimized for performance */
      .sheet {
        position: fixed;
        left: 0;
        right: 0;
        bottom: -100%;
        background: #0b1220;
        border-top: 1px solid #1f2937;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        padding: 20px;
        transition: bottom 0.2s ease-out;
        max-height: 75svh;
        display: flex;
        flex-direction: column;
        gap: 16px;
        overflow-y: auto;
        z-index: 1000;
        transform: translateZ(0);
        will-change: transform;
        user-select: none;
        touch-action: pan-y;
        -webkit-overflow-scrolling: touch;
      }
      .sheet.open {
        bottom: 0;
      }
      .sheet.dragging {
        transition: none;
      }
      .sheet .drag {
        width: 90px !important;
        height: 5px !important;
        flex-shrink: 0;
        background: #334155;
        border-radius: 999px;
        margin: 10px auto;
        z-index: 50;
        cursor: grab;
        position: relative;
      }
      .sheet .drag:before {
        content: "";
        position: absolute;
        top: -10px;
        left: -20px;
        right: -20px;
        bottom: -10px;
        border-radius: 20px;
        background: transparent;
      }

      /* Enhanced overlay - Simplified */
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
        transition: opacity 0.2s ease-out;
      }
      .overlay.active {
        display: block;
      }
      .sheet h3 {
        margin: 0;
        font-size: 16px;
      }
      .row {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 8px;
      }
      label {
        font-size: 14px;
        color: var(--muted);
        font-weight: 600;
        letter-spacing: 0.3px;
      }
      input,
      textarea,
      select {
        width: 100%;
        background: #0f172a;
        color: var(--text);
        border: 1px solid #263247;
        border-radius: 14px;
        padding: 16px 20px;
        font: inherit;
        outline: none;
        transition: 0.2s border-color;
        font-size: 15px;
        line-height: 1.4;
      }
      input:focus,
      textarea:focus,
      select:focus {
        border-color: var(--accent-2);
      }
      textarea {
        min-height: 70px;
        resize: vertical;
      }
      .sheet .actions {
        display: flex;
        gap: 12px;
        justify-content: space-between;
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid #1f2937;
      }
      .grow {
        flex: 1;
      }
      .danger {
        background: #1a1010;
        border-color: #3a1c1c;
      }

      /* Events List */
      .events-list {
        display: flex;
        flex-direction: column;
        gap: 24px;
        margin-bottom: 20px;
        padding: 0;
      }
      .event-item {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 14px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px;
      }
      .event-item .content {
        flex: 1;
        min-width: 0;
      }
      .event-item .title {
        font-weight: 700;
        font-size: 16px;
        margin-bottom: 8px;
        color: var(--text);
        line-height: 1.2;
      }
      .event-item .details {
        font-size: 13px;
        color: var(--muted);
        line-height: 1.5;
        margin-bottom: 8px;
        white-space: pre-line;
      }
      .event-item .notes {
        font-size: 14px;
        color: var(--muted);
        line-height: 1.5;
        font-style: italic;
      }
      .event-item .actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid #334155;
      }
      .event-item .btn {
        padding: 8px 16px;
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        min-height: 36px;
        width: 70px;
        flex: 0 0 auto;
      }
      .event-form {
        display: none;
      }
      .event-form.show {
        display: block;
      }

      /* Table Styles for Month View */
      .table-container {
        width: 100%;
        overflow-x: auto;
        border-radius: 14px;
        box-shadow: var(--shadow);
        background: #1e293b;
        -webkit-overflow-scrolling: touch;
        /* Add scrollbar styling */
        scrollbar-width: thin;
        scrollbar-color: var(--accent) transparent;
      }
      .table-container::-webkit-scrollbar {
        height: 8px;
      }
      .table-container::-webkit-scrollbar-track {
        background: transparent;
      }
      .table-container::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 4px;
      }
      .table-container::-webkit-scrollbar-thumb:hover {
        background: var(--accent-dark);
      }
      .events-table {
        width: 100%;
        min-width: 820px; /* Minimum width to ensure all columns are visible */
        border-collapse: collapse;
        background: #1e293b;
        margin: 0;
      }
      .events-table th,
      .events-table td {
        padding: 12px 8px;
        text-align: left;
        border-bottom: 1px solid #334155;
        font-size: 12px;
      }
      .events-table th {
        background: #0f172a;
        color: var(--accent);
        font-weight: 700;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .events-table td {
        color: var(--text);
        vertical-align: top;
      }
      .events-table tr:hover {
        background: rgba(255, 255, 255, 0.02);
      }
      .events-table .date-col {
        white-space: nowrap;
        width: 120px;
        font-weight: 600;
        font-size: 11px;
      }
      .events-table .guest-col {
        width: 120px;
      }
      .events-table .pax-col {
        width: 60px;
        text-align: center;
      }
      .events-table .venue-col {
        width: 100px;
      }
      .events-table .food-col {
        width: 80px;
        text-align: center;
      }
      .events-table .time-col {
        width: 140px;
        font-size: 11px;
        white-space: nowrap;
      }
      .events-table .actions-col {
        width: 120px;
        text-align: center;
      }
      .food-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .food-badge.with-food {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
      }
      .food-badge.without-food {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
      }
      .table-actions {
        display: flex;
        gap: 4px;
        justify-content: center;
      }
      .table-actions .btn {
        padding: 4px 8px;
        font-size: 10px;
        min-height: 24px;
        width: auto;
      }

      /* Small helpers */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }

      /* Loading states */
      .loading {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
      }
      .loading::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        border: 2px solid var(--muted);
        border-radius: 50%;
        border-top-color: var(--accent);
        animation: spin 1s linear infinite;
        z-index: 10;
      }
      .btn.loading {
        color: transparent;
      }
      .btn.loading::after {
        width: 16px;
        height: 16px;
        border-width: 2px;
      }
      @keyframes spin {
        to {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }
      .calendar.loading::after {
        width: 30px;
        height: 30px;
        border-width: 3px;
      }
      .events-list.loading::after {
        width: 25px;
        height: 25px;
        border-width: 2px;
      }

      @media (min-height: 900px) {
        .app {
          max-height: 920px;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/localizedFormat.js"></script>
  </head>
  <body>
    <!-- Add overlay element -->
    <div class="overlay" id="overlay"></div>

    <main class="app" aria-label="Calendar App">
      <header class="bar">
        <div class="title" aria-live="polite">
          <span class="month" id="label-month">Month</span>
          <select class="year" id="label-year">
            <!-- Year options will be populated by JavaScript -->
          </select>
        </div>
        <div class="nav">
          <button
            class="btn icon secondary"
            id="prev"
            aria-label="Previous month"
          >
            ◀
          </button>
          <button class="btn icon secondary" id="next" aria-label="Next month">
            ▶
          </button>
          <button class="btn secondary" id="today">Today</button>
        </div>
      </header>
      <section class="calendar" role="grid" aria-labelledby="label-month">
        <div class="weekdays" role="row">
          <div>Sun</div>
          <div>Mon</div>
          <div>Tue</div>
          <div>Wed</div>
          <div>Thu</div>
          <div>Fri</div>
          <div>Sat</div>
        </div>
        <div class="grid" id="grid" role="rowgroup"></div>
        <div class="footer">
          <button class="btn" id="addQuick">＋ Quick Add</button>
          <div style="display: flex; gap: 8px; align-items: center">
            <label class="sr-only" for="toggle-hijri">Show Hijri</label>
            <input type="checkbox" id="toggle-hijri" />
            <span style="font-size: 12px; color: var(--muted)">Hijri</span>
          </div>
        </div>
      </section>
    </main>
    <!-- Bottom Sheet: Add/View Events -->
    <aside
      class="sheet"
      id="sheet"
      aria-hidden="true"
      aria-label="Event Editor"
    >
      <div class="drag" id="drag-handler"></div>
      <h3 id="sheet-title">Events</h3>

      <!-- Events List -->
      <div id="events-list" class="events-list" style="display: none">
        <!-- Events will be populated here -->
      </div>

      <!-- Add Event Button -->
      <button id="add-event-btn" class="btn accent" style="display: none">
        ＋ Add Event
      </button>

      <!-- Event Form -->
      <form id="event-form" class="event-form" novalidate>
        <div class="row">
          <label for="ev-title">Title</label>
          <input id="ev-title" placeholder="e.g., Team Meeting" required />
        </div>
        <div class="row">
          <label for="ev-notes">Notes</label>
          <textarea
            id="ev-notes"
            placeholder="Details, location, etc."
          ></textarea>
        </div>
        <div class="row">
          <label>Start Date & Time</label>
          <div style="display: flex; gap: 8px">
            <input id="ev-start-date" type="date" required style="flex: 1" />
            <input id="ev-start-time" type="time" required style="flex: 1" />
          </div>
        </div>
        <div class="row">
          <label>End Date & Time</label>
          <div style="display: flex; gap: 8px">
            <input id="ev-end-date" type="date" required style="flex: 1" />
            <input id="ev-end-time" type="time" required style="flex: 1" />
          </div>
        </div>
        <div class="row">
          <label for="ev-guest-name">Guest Name</label>
          <input id="ev-guest-name" placeholder="e.g., John Doe" required />
        </div>
        <div class="row">
          <label for="ev-phone">Guest Phone</label>
          <input
            id="ev-phone"
            type="tel"
            placeholder="e.g., +1234567890"
            required
          />
        </div>
        <div class="row">
          <label for="ev-pax">Pax (No. of Guests)</label>
          <input
            id="ev-pax"
            type="number"
            min="1"
            placeholder="e.g., 50"
            required
          />
        </div>
        <div class="row">
          <label for="ev-venue">Venue</label>
          <select id="ev-venue" required>
            <option value="Dar-ul-Khaas">Dar-ul-Khaas</option>
            <option value="Aroos-ul-Bahar">Aroos-ul-Bahar</option>
            <option value="Grand Marquee">Grand Marquee</option>
          </select>
        </div>
        <div class="row">
          <label style="display: flex; align-items: center; gap: 8px">
            <input type="checkbox" id="ev-with-food" style="width: auto" />
            With Food
          </label>
        </div>
        <div class="actions">
          <button type="button" class="btn secondary" id="cancel">
            Cancel
          </button>
          <button type="submit" class="btn accent" id="save">Save</button>
        </div>
      </form>
    </aside>
    <script>
      // Initialize Day.js plugins
      dayjs.extend(dayjs_plugin_relativeTime)
      dayjs.extend(dayjs_plugin_localizedFormat)

      // --- Utilities ---
      const pad = (n) => String(n).padStart(2, "0")
      const toKey = (d) =>
        `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`
      const parseKey = (k) => {
        const [y, m, d] = k.split("-").map(Number)
        return new Date(y, m - 1, d)
      }
      const today = new Date()

      // Date formatting helper
      const formatDateTime = (dateString) => {
        if (!dateString) return ""
        return dayjs(dateString).format("MMM DD, YYYY [at] h:mm A")
      }

      const formatDateOnly = (dateString) => {
        if (!dateString) return ""
        return dayjs(dateString).format("MMM DD, YYYY")
      }

      // Timezone hint (Asia/Karachi)
      try {
        document.title = `Calendar — ${Intl.DateTimeFormat([], {
          timeZone: "Asia/Karachi",
          dateStyle: "long"
        }).format(today)}`
      } catch {}

      // In-memory cache (always refreshed from API)
      let events = {}

      // API helpers
      async function apiCall(url, options = {}) {
        try {
          const response = await fetch(url, {
            headers: {
              "Content-Type": "application/json",
              ...options.headers
            },
            ...options
          })
          const data = await response.json()

          if (!data.success) {
            throw new Error(data.error || "API call failed")
          }

          return data
        } catch (error) {
          console.error("API Error:", error)
          throw error
        }
      }

      // Load all events from server
      async function loadEvents() {
        try {
          els.calendar.classList.add("loading")
          const response = await apiCall("/api/events")
          events = response.data || {}
          render()
        } catch (error) {
          console.error("Failed to load events:", error)
          // No local fallback; API is the source of truth
          events = {}
          render()
        } finally {
          els.calendar.classList.remove("loading")
        }
      }

      // Create new event
      async function createEvent(dateKey, eventData) {
        try {
          const response = await apiCall("/api/events", {
            method: "POST",
            body: JSON.stringify({ dateKey, event: eventData })
          })

          // Always reload from API to keep in sync
          await loadEvents()

          return response.data
        } catch (error) {
          console.error("Failed to create event:", error)
          throw error
        }
      }

      // Update existing event
      async function updateEvent(dateKey, eventId, eventData) {
        try {
          const response = await apiCall(`/api/events/${dateKey}/${eventId}`, {
            method: "PUT",
            body: JSON.stringify(eventData)
          })

          // Reload from API; avoid mutating possibly stale local array
          await loadEvents()

          return response.data
        } catch (error) {
          console.error("Failed to update event:", error)
          throw error
        }
      }

      // Delete event
      async function deleteEventAPI(dateKey, eventId) {
        try {
          await apiCall(`/api/events/${dateKey}/${eventId}`, {
            method: "DELETE"
          })

          // Reload from API to reflect deletion
          await loadEvents()

          return true
        } catch (error) {
          console.error("Failed to delete event:", error)
          throw error
        }
      }

      // State
      let view = new Date(today.getFullYear(), today.getMonth(), 1)
      let selectedKey = null // currently editing date key
      let showHijri = false

      // Constants
      const MAX_YEAR = 2030

      const els = {
        calendar: document.querySelector(".calendar"),
        month: document.getElementById("label-month"),
        year: document.getElementById("label-year"),
        grid: document.getElementById("grid"),
        prev: document.getElementById("prev"),
        next: document.getElementById("next"),
        todayBtn: document.getElementById("today"),
        addQuick: document.getElementById("addQuick"),
        toggleHijri: document.getElementById("toggle-hijri"),
        sheet: document.getElementById("sheet"),
        sheetTitle: document.getElementById("sheet-title"),
        eventsList: document.getElementById("events-list"),
        addEventBtn: document.getElementById("add-event-btn"),
        eventForm: document.getElementById("event-form"),
        evTitle: document.getElementById("ev-title"),
        evNotes: document.getElementById("ev-notes"),
        evStartDate: document.getElementById("ev-start-date"),
        evStartTime: document.getElementById("ev-start-time"),
        evEndDate: document.getElementById("ev-end-date"),
        evEndTime: document.getElementById("ev-end-time"),
        evGuestName: document.getElementById("ev-guest-name"),
        evPhone: document.getElementById("ev-phone"),
        evPax: document.getElementById("ev-pax"),
        evVenue: document.getElementById("ev-venue"),
        evWithFood: document.getElementById("ev-with-food"),
        save: document.getElementById("save"),
        cancel: document.getElementById("cancel")
      }

      // Try detect Hijri support
      let hijriSupported = false
      try {
        const t = new Intl.DateTimeFormat("en-u-ca-islamic", {
          day: "numeric"
        }).format(new Date())
        hijriSupported = !!t
      } catch {
        hijriSupported = false
      }
      els.toggleHijri.disabled = !hijriSupported

      // Render calendar grid
      function render() {
        els.month.textContent = view.toLocaleString(undefined, {
          month: "long"
        })
        // Update the year selector value to match current view
        if (els.year.value !== view.getFullYear().toString()) {
          els.year.value = view.getFullYear()
        }

        const start = new Date(view.getFullYear(), view.getMonth(), 1)
        const startDay = start.getDay() // 0 Sun ... 6 Sat
        const daysInMonth = new Date(
          view.getFullYear(),
          view.getMonth() + 1,
          0
        ).getDate()

        const prevMonthDays = new Date(
          view.getFullYear(),
          view.getMonth(),
          0
        ).getDate()
        const cells = []

        // leading faded days from previous month
        for (let i = startDay - 1; i >= 0; i--) {
          const d = new Date(
            view.getFullYear(),
            view.getMonth() - 1,
            prevMonthDays - i
          )
          cells.push(cellTemplate(d, true))
        }
        // days of current month
        for (let i = 1; i <= daysInMonth; i++) {
          const d = new Date(view.getFullYear(), view.getMonth(), i)
          cells.push(cellTemplate(d, false))
        }
        // trailing days for full weeks (up to 42 cells, 6 weeks)
        while (cells.length % 7 !== 0) {
          const last = parseKey(cells[cells.length - 1].dataset.key)
          const d = new Date(
            last.getFullYear(),
            last.getMonth(),
            last.getDate() + 1
          )
          cells.push(cellTemplate(d, true))
        }

        els.grid.innerHTML = ""
        cells.forEach((c) => els.grid.appendChild(c))
      }

      function cellTemplate(dateObj, faded) {
        const key = toKey(dateObj)
        const cell = document.createElement("button")
        cell.type = "button"
        cell.className =
          "cell" +
          (faded ? " faded" : "") +
          (sameDate(dateObj, today) ? " today" : "")
        cell.setAttribute("role", "gridcell")
        cell.dataset.key = key

        const head = document.createElement("div")
        head.className = "date"
        head.innerHTML = `<span>${dateObj.getDate()}</span>`

        if (showHijri && hijriSupported) {
          try {
            const hijriDay = new Intl.DateTimeFormat("ar-u-ca-islamic", {
              day: "numeric"
            }).format(dateObj)
            const hijri = document.createElement("span")
            hijri.className = "hijri"
            hijri.textContent = hijriDay
            head.appendChild(hijri)
          } catch {}
        }

        const eventWrap = document.createElement("div")
        eventWrap.className = "events"
        ;(events[key] || []).slice(0, 3).forEach((e) => {
          const p = document.createElement("span")
          p.className = "pill"
          p.textContent = e.title
          eventWrap.appendChild(p)
        })
        if ((events[key] || []).length > 3) {
          const more = document.createElement("span")
          more.className = "pill"
          more.textContent = `+${events[key].length - 3} more`
          eventWrap.appendChild(more)
        }

        cell.appendChild(head)
        cell.appendChild(eventWrap)
        cell.addEventListener("click", () => openSheetForDate(key))
        return cell
      }

      function sameDate(a, b) {
        return (
          a.getFullYear() === b.getFullYear() &&
          a.getMonth() === b.getMonth() &&
          a.getDate() === b.getDate()
        )
      }

      function openSheetForMonth() {
        const monthName = view.toLocaleString(undefined, { month: "long" })
        const year = view.getFullYear()

        // Get all events for the current month
        const monthEvents = []
        const startOfMonth = new Date(year, view.getMonth(), 1)
        const endOfMonth = new Date(year, view.getMonth() + 1, 0)

        for (let day = 1; day <= endOfMonth.getDate(); day++) {
          const date = new Date(year, view.getMonth(), day)
          const key = toKey(date)
          const dayEvents = events[key] || []

          dayEvents.forEach((event) => {
            monthEvents.push({
              ...event,
              date: date,
              dateString: date.toLocaleDateString()
            })
          })
        }

        // Sort events by date and time
        monthEvents.sort((a, b) => {
          const dateCompare = a.date.getTime() - b.date.getTime()
          if (dateCompare !== 0) return dateCompare

          // If same date, sort by start time
          if (a.start && b.start) {
            return new Date(a.start).getTime() - new Date(b.start).getTime()
          }
          return 0
        })

        els.sheetTitle.textContent = `${monthName} ${year} - All Events (${monthEvents.length})`

        if (monthEvents.length > 0) {
          showMonthEventsList(monthEvents)
          els.addEventBtn.style.display = "none"
          els.eventForm.style.display = "none"
        } else {
          els.eventsList.innerHTML =
            '<div style="text-align: center; color: var(--muted); padding: 40px 20px; font-style: italic;">No events found for this month</div>'
          els.eventsList.style.display = "block"
          els.addEventBtn.style.display = "none"
          els.eventForm.style.display = "none"
        }

        openDrawer()
      }

      function showMonthEventsList(monthEvents) {
        els.eventsList.innerHTML = ""
        els.eventsList.style.display = "block"

        // Create table container for horizontal scrolling
        const tableContainer = document.createElement("div")
        tableContainer.className = "table-container"

        // Create table
        const table = document.createElement("table")
        table.className = "events-table"

        // Create header
        const thead = document.createElement("thead")
        const headerRow = document.createElement("tr")

        const headers = [
          { text: "Date", class: "date-col" },
          { text: "Guest Name", class: "guest-col" },
          { text: "Pax", class: "pax-col" },
          { text: "Venue", class: "venue-col" },
          { text: "W/Food", class: "food-col" },
          { text: "Time", class: "time-col" },
          { text: "Actions", class: "actions-col" }
        ]

        headers.forEach((header) => {
          const th = document.createElement("th")
          th.className = header.class
          th.textContent = header.text
          headerRow.appendChild(th)
        })

        thead.appendChild(headerRow)
        table.appendChild(thead)

        // Create body
        const tbody = document.createElement("tbody")

        monthEvents.forEach((event, index) => {
          const row = document.createElement("tr")

          // Date column
          const dateCell = document.createElement("td")
          dateCell.className = "date-col"

          let dateText = ""
          if (event.start && event.end) {
            const startDate = new Date(event.start)
            const endDate = new Date(event.end)

            // Check if start and end dates are the same day
            if (startDate.toDateString() === endDate.toDateString()) {
              dateText = startDate.toLocaleDateString("en-US", {
                month: "2-digit",
                day: "2-digit",
                year: "2-digit"
              })
            } else {
              dateText = `${startDate.toLocaleDateString("en-US", {
                month: "2-digit",
                day: "2-digit",
                year: "2-digit"
              })} - ${endDate.toLocaleDateString("en-US", {
                month: "2-digit",
                day: "2-digit",
                year: "2-digit"
              })}`
            }
          } else {
            const eventDate = new Date(event.start || event.date)
            dateText = eventDate.toLocaleDateString("en-US", {
              month: "2-digit",
              day: "2-digit",
              year: "2-digit"
            })
          }

          dateCell.textContent = dateText
          row.appendChild(dateCell)

          // Guest Name column
          const guestCell = document.createElement("td")
          guestCell.className = "guest-col"
          guestCell.textContent = event.guestName || "-"
          row.appendChild(guestCell)

          // Pax column
          const paxCell = document.createElement("td")
          paxCell.className = "pax-col"
          paxCell.textContent = event.pax || "-"
          row.appendChild(paxCell)

          // Venue column
          const venueCell = document.createElement("td")
          venueCell.className = "venue-col"
          venueCell.textContent = event.venue || "-"
          row.appendChild(venueCell)

          // With Food column
          const foodCell = document.createElement("td")
          foodCell.className = "food-col"
          const foodBadge = document.createElement("span")
          foodBadge.className = `food-badge ${
            event.withFood ? "with-food" : "without-food"
          }`
          foodBadge.textContent = event.withFood ? "w/Food" : "w/o"
          foodCell.appendChild(foodBadge)
          row.appendChild(foodCell)

          // Time column
          const timeCell = document.createElement("td")
          timeCell.className = "time-col"

          let timeText = ""
          if (event.start && event.end) {
            const startTime = new Date(event.start)
            const endTime = new Date(event.end)

            const startTimeStr = startTime.toLocaleTimeString("en-US", {
              hour: "numeric",
              minute: "2-digit",
              hour12: true
            })
            const endTimeStr = endTime.toLocaleTimeString("en-US", {
              hour: "numeric",
              minute: "2-digit",
              hour12: true
            })

            // Check if times are the same
            if (startTimeStr === endTimeStr) {
              timeText = startTimeStr
            } else {
              timeText = `${startTimeStr} - ${endTimeStr}`
            }
          } else if (event.start) {
            const startTime = new Date(event.start)
            timeText = startTime.toLocaleTimeString("en-US", {
              hour: "numeric",
              minute: "2-digit",
              hour12: true
            })
          } else {
            timeText = "-"
          }

          timeCell.textContent = timeText
          row.appendChild(timeCell)

          // Actions column
          const actionsCell = document.createElement("td")
          actionsCell.className = "actions-col"

          const actionsDiv = document.createElement("div")
          actionsDiv.className = "table-actions"

          const editBtn = document.createElement("button")
          editBtn.className = "btn secondary"
          editBtn.textContent = "Edit"
          editBtn.addEventListener("click", () => {
            // Find the event in its original date and edit it
            const eventKey = toKey(event.date)
            const dayEvents = events[eventKey] || []
            const eventIndex = dayEvents.findIndex((e) => e.id === event.id)

            if (eventIndex !== -1) {
              selectedKey = eventKey
              editEvent(eventIndex)
            }
          })

          const deleteBtn = document.createElement("button")
          deleteBtn.className = "btn danger"
          deleteBtn.textContent = "Del"
          deleteBtn.addEventListener("click", async () => {
            if (!confirm("Delete this event?")) return

            // Find the event in its original date and delete it
            const eventKey = toKey(event.date)

            try {
              deleteBtn.classList.add("loading")
              deleteBtn.disabled = true

              await deleteEventAPI(eventKey, event.id)
              render()

              // Refresh the month view
              openSheetForMonth()
            } catch (error) {
              alert("Failed to delete event. Please try again.")
            } finally {
              deleteBtn.classList.remove("loading")
              deleteBtn.disabled = false
            }
          })

          actionsDiv.appendChild(editBtn)
          actionsDiv.appendChild(deleteBtn)
          actionsCell.appendChild(actionsDiv)
          row.appendChild(actionsCell)

          tbody.appendChild(row)
        })

        table.appendChild(tbody)
        tableContainer.appendChild(table)
        els.eventsList.appendChild(tableContainer)
      }

      function openSheetForDate(key) {
        selectedKey = key
        const d = parseKey(key)
        const list = events[key] || []

        els.sheetTitle.textContent = `${d.toLocaleString(undefined, {
          weekday: "long"
        })}, ${d.toLocaleDateString()}`

        // Show events list if events exist
        if (list.length > 0) {
          showEventsList(list)
          els.addEventBtn.style.display = "block"
          els.eventForm.style.display = "none"
        } else {
          // Show form directly if no events
          els.eventsList.style.display = "none"
          els.addEventBtn.style.display = "none"
          els.eventForm.style.display = "block"
          clearForm()
          // Prefill start/end dates from selected day; keep times empty
          const dIso = key
          els.evStartDate.value = dIso
          els.evEndDate.value = dIso
          els.evStartTime.value = ""
          els.evEndTime.value = ""
        }

        openDrawer()
      }

      function closeSheet() {
        closeDrawer()
      }

      function showEventsList(list) {
        els.eventsList.innerHTML = ""
        els.eventsList.style.display = "block"

        list.forEach((event, index) => {
          const eventItem = document.createElement("div")
          eventItem.className = "event-item"

          const content = document.createElement("div")
          content.className = "content"

          const title = document.createElement("div")
          title.className = "title"
          title.textContent = event.title

          const details = document.createElement("div")
          details.className = "details"

          let detailsText = ""
          if (event.venue) detailsText += `📍 ${event.venue}\n`
          if (event.guestName) detailsText += `👤 ${event.guestName}\n`
          if (event.phone) detailsText += `📞 ${event.phone}\n`
          if (event.pax) detailsText += `👥 ${event.pax} guests\n`
          detailsText += `🍽️ ${event.withFood ? "With Food" : "Without Food"}\n`
          if (event.start) {
            detailsText += `🕐 Start: ${formatDateTime(event.start)}\n`
          }
          if (event.end) {
            detailsText += `🕐 End: ${formatDateTime(event.end)}\n`
          }

          details.textContent = detailsText.trim() || "No additional details"

          const notes = document.createElement("div")
          notes.className = "notes"
          notes.textContent = event.notes ? `"${event.notes}"` : ""

          const actions = document.createElement("div")
          actions.className = "actions"

          const editBtn = document.createElement("button")
          editBtn.className = "btn secondary"
          editBtn.textContent = "Edit"
          editBtn.addEventListener("click", () => editEvent(index))

          const deleteBtn = document.createElement("button")
          deleteBtn.className = "btn danger"
          deleteBtn.textContent = "Delete"
          deleteBtn.addEventListener("click", () => deleteEvent(index))

          content.appendChild(title)
          content.appendChild(details)
          if (event.notes) content.appendChild(notes)

          actions.appendChild(editBtn)
          actions.appendChild(deleteBtn)

          eventItem.appendChild(content)
          eventItem.appendChild(actions)
          els.eventsList.appendChild(eventItem)
        })
      }
      function editEvent(index) {
        const list = events[selectedKey] || []
        const event = list[index]

        els.evTitle.value = event.title || ""
        els.evNotes.value = event.notes || ""
        if (event.start) {
          const s = new Date(event.start)
          els.evStartDate.value = `${s.getFullYear()}-${pad(
            s.getMonth() + 1
          )}-${pad(s.getDate())}`
          els.evStartTime.value = `${pad(s.getHours())}:${pad(s.getMinutes())}`
        } else {
          els.evStartDate.value = selectedKey || ""
          els.evStartTime.value = ""
        }
        if (event.end) {
          const e = new Date(event.end)
          els.evEndDate.value = `${e.getFullYear()}-${pad(
            e.getMonth() + 1
          )}-${pad(e.getDate())}`
          els.evEndTime.value = `${pad(e.getHours())}:${pad(e.getMinutes())}`
        } else {
          els.evEndDate.value = els.evStartDate.value
          els.evEndTime.value = ""
        }
        els.evGuestName.value = event.guestName || ""
        els.evPhone.value = event.phone || ""
        els.evPax.value = event.pax || ""
        els.evVenue.value = event.venue || "Dar-ul-Khaas"
        els.evWithFood.checked = event.withFood || false

        els.eventsList.style.display = "none"
        els.addEventBtn.style.display = "none"
        els.eventForm.style.display = "block"

        // Store the index and ID being edited
        els.eventForm.dataset.editIndex = index
        els.eventForm.dataset.editEventId = event.id
      }

      async function deleteEvent(index) {
        if (!selectedKey) return

        const list = events[selectedKey] || []
        const event = list[index]

        if (!event.id) {
          // No local delete without ID; refresh from server to reconcile
          await loadEvents()
          const refreshed = events[selectedKey] || []
          if (refreshed.length > 0) {
            showEventsList(refreshed)
          } else {
            els.eventsList.style.display = "none"
            els.addEventBtn.style.display = "none"
            els.eventForm.style.display = "block"
            clearForm()
          }
          return
        }

        try {
          // Show loading state on the delete button
          const deleteButtons = document.querySelectorAll(
            ".event-item .btn.danger"
          )
          if (deleteButtons[index]) {
            deleteButtons[index].classList.add("loading")
            deleteButtons[index].disabled = true
          }

          await deleteEventAPI(selectedKey, event.id)
          render()

          // Refresh the events list
          const updatedList = events[selectedKey] || []
          if (updatedList.length > 0) {
            showEventsList(updatedList)
          } else {
            els.eventsList.style.display = "none"
            els.addEventBtn.style.display = "none"
            els.eventForm.style.display = "block"
            clearForm()
          }
        } catch (error) {
          alert("Failed to delete event. Please try again.")
        } finally {
          // Remove loading state
          const deleteButtons = document.querySelectorAll(
            ".event-item .btn.danger"
          )
          if (deleteButtons[index]) {
            deleteButtons[index].classList.remove("loading")
            deleteButtons[index].disabled = false
          }
        }
      }

      function clearForm() {
        els.evTitle.value = ""
        els.evNotes.value = ""
        els.evStartDate.value = ""
        els.evStartTime.value = ""
        els.evEndDate.value = ""
        els.evEndTime.value = ""
        els.evGuestName.value = ""
        els.evPhone.value = ""
        els.evPax.value = ""
        els.evVenue.value = "Dar-ul-Khaas"
        els.evWithFood.checked = false
        delete els.eventForm.dataset.editIndex
        delete els.eventForm.dataset.editEventId
      }

      // Actions
      els.month.addEventListener("click", () => {
        openSheetForMonth()
      })

      els.prev.addEventListener("click", () => {
        view = new Date(view.getFullYear(), view.getMonth() - 1, 1)
        render()
        updateNavigationButtons()
      })
      els.next.addEventListener("click", () => {
        view = new Date(view.getFullYear(), view.getMonth() + 1, 1)
        render()
        updateNavigationButtons()
      })
      els.todayBtn.addEventListener("click", () => {
        view = new Date(today.getFullYear(), today.getMonth(), 1)
        render()
        updateNavigationButtons()
      })
      els.addQuick.addEventListener("click", () => {
        openSheetForDate(toKey(today))
      })

      // Form submission with validation
      els.eventForm.addEventListener("submit", async (e) => {
        e.preventDefault()
        if (!selectedKey) return

        // Native constraint validation first
        if (!els.eventForm.checkValidity()) {
          els.eventForm.reportValidity()
          return
        }

        // Compose ISO datetimes from date+time; times are required by inputs
        const startIso = new Date(
          `${els.evStartDate.value}T${els.evStartTime.value}:00`
        ).toISOString()
        const endIso = new Date(
          `${els.evEndDate.value}T${els.evEndTime.value}:00`
        ).toISOString()

        // Extra validations
        if (new Date(endIso) < new Date(startIso)) {
          alert("End must be after Start.")
          return
        }

        const paxVal = parseInt(els.evPax.value)
        if (Number.isNaN(paxVal) || paxVal < 1) {
          alert("Pax must be a positive number.")
          return
        }

        const entry = {
          title: els.evTitle.value.trim(),
          notes: els.evNotes.value.trim() || "",
          start: startIso,
          end: endIso,
          guestName: els.evGuestName.value.trim(),
          phone: els.evPhone.value.trim(),
          pax: paxVal,
          venue: els.evVenue.value,
          withFood: els.evWithFood.checked
        }

        try {
          els.save.classList.add("loading")
          els.save.disabled = true

          const editIndex = els.eventForm.dataset.editIndex
          const editEventId = els.eventForm.dataset.editEventId

          if (editIndex !== undefined && editEventId) {
            await updateEvent(selectedKey, editEventId, entry)
          } else {
            await createEvent(selectedKey, entry)
          }

          await loadEvents()

          if (selectedKey) {
            const list = events[selectedKey] || []
            showEventsList(list)
            els.addEventBtn.style.display = "block"
            els.eventForm.style.display = "none"
          }

          render()
        } catch (error) {
          alert("Failed to save event. Please try again.")
        } finally {
          els.save.classList.remove("loading")
          els.save.disabled = false
        }
      })

      els.cancel.addEventListener("click", () => {
        // If editing, go back to events list; if adding new, close sheet
        if (els.eventForm.dataset.editIndex !== undefined) {
          const list = events[selectedKey] || []
          if (list.length > 0) {
            showEventsList(list)
            els.addEventBtn.style.display = "block"
            els.eventForm.style.display = "none"
          } else {
            closeSheet()
          }
        } else {
          closeSheet()
        }
      })

      // Add Event button functionality
      els.addEventBtn.addEventListener("click", () => {
        clearForm()
        els.eventsList.style.display = "none"
        els.addEventBtn.style.display = "none"
        els.eventForm.style.display = "block"
        if (selectedKey) {
          els.evStartDate.value = selectedKey
          els.evEndDate.value = selectedKey
          els.evStartTime.value = ""
          els.evEndTime.value = ""
        }
      })

      els.toggleHijri.addEventListener("change", (e) => {
        showHijri = e.target.checked
        render()
      })

      // Enhanced drag system with Hammer.js
      const sheet = document.getElementById("sheet")
      const dragHandler = document.getElementById("drag-handler")
      const overlay = document.getElementById("overlay")

      let sheetHeight = 0
      let dragStartPosition = 0
      let currentDragPosition = 0
      let isAnimating = false
      let velocityTracker = []

      // Initialize Hammer.js with minimal settings
      const hammerSheet = new Hammer(sheet, {
        direction: Hammer.DIRECTION_VERTICAL,
        threshold: 5,
        pointers: 1
      })

      hammerSheet.get("pan").set({
        direction: Hammer.DIRECTION_DOWN
      })

      // Enhanced drag start - Minimal processing
      hammerSheet.on("panstart", (e) => {
        if (isAnimating) return

        sheetHeight = sheet.offsetHeight
        currentDragPosition = 0
        velocityTracker = []

        // Simple state changes
        sheet.classList.add("dragging")
        document.body.style.overflow = "hidden"
      })

      // Enhanced drag move - Simplified for performance
      hammerSheet.on("panmove", (e) => {
        if (isAnimating) return

        const deltaY = Math.max(0, e.deltaY)
        currentDragPosition = deltaY

        // Simple velocity tracking
        velocityTracker.push({
          position: deltaY,
          time: Date.now()
        })

        if (velocityTracker.length > 2) {
          velocityTracker.shift()
        }

        // Simple linear drag without resistance
        const newBottom = Math.max(-deltaY, -sheetHeight)
        sheet.style.bottom = `${newBottom}px`

        // Simple opacity fade
        const progress = Math.min(deltaY / (sheetHeight * 0.5), 1)
        overlay.style.opacity = 1 - progress * 0.7
      })

      // Simplified drag end
      hammerSheet.on("panend", (e) => {
        if (isAnimating) return

        isAnimating = true
        const deltaY = currentDragPosition

        // Simple velocity calculation
        let velocity = 0
        if (velocityTracker.length >= 2) {
          const recent = velocityTracker[velocityTracker.length - 1]
          const prev = velocityTracker[0]
          velocity =
            (recent.position - prev.position) / (recent.time - prev.time)
        }

        // Simple threshold
        const shouldClose = deltaY > sheetHeight * 0.2 || velocity > 0.5

        // Clean up
        sheet.classList.remove("dragging")
        document.body.style.overflow = ""

        if (shouldClose) {
          // Fast close with CSS transition
          sheet.style.bottom = "-100%"
          overlay.style.opacity = "0"

          setTimeout(() => {
            sheet.setAttribute("aria-hidden", "true")
            overlay.classList.remove("active")
            sheet.classList.remove("open")
            resetSheetStyles()
            isAnimating = false
          }, 150)
        } else {
          // Fast snap back
          sheet.style.bottom = "0px"
          overlay.style.opacity = "1"

          setTimeout(() => {
            resetSheetStyles()
            isAnimating = false
          }, 150)
        }

        velocityTracker = []
      })

      // Prevent scrolling when dragging on mobile
      hammerSheet.on("panstart panmove", (e) => {
        e.preventDefault()
        e.srcEvent.preventDefault()
      })

      // Enhanced overlay click handler
      overlay.addEventListener("click", (e) => {
        if (!isAnimating) {
          closeDrawer()
        }
      })

      // Utility function to reset all sheet styles
      function resetSheetStyles() {
        sheet.style.bottom = ""
        sheet.style.transform = ""
        overlay.style.opacity = ""
      }

      function closeDrawer() {
        if (isAnimating) return
        isAnimating = true

        // Use CSS transitions instead of GSAP
        sheet.style.bottom = "-100%"
        overlay.style.opacity = "0"

        setTimeout(() => {
          sheet.setAttribute("aria-hidden", "true")
          overlay.classList.remove("active")
          sheet.classList.remove("open")
          resetSheetStyles()
          isAnimating = false
        }, 200)
      }

      function openDrawer() {
        if (isAnimating) return
        isAnimating = true

        // Reset styles
        resetSheetStyles()

        // Use CSS transitions
        sheet.setAttribute("aria-hidden", "false")
        overlay.classList.add("active")
        sheet.classList.add("open")

        // Small delay to ensure DOM update
        requestAnimationFrame(() => {
          sheet.style.bottom = "0"
          overlay.style.opacity = "1"

          setTimeout(() => {
            isAnimating = false
          }, 200)
        })
      }

      function updateNavigationButtons() {
        if (view.getFullYear() >= MAX_YEAR) {
          els.next.disabled = true
          els.next.style.opacity = "0.5"
          els.next.style.cursor = "not-allowed"
        } else {
          els.next.disabled = false
          els.next.style.opacity = "1"
          els.next.style.cursor = "pointer"
        }
      }

      function populateYearSelector() {
        const currentYear = today.getFullYear()

        els.year.innerHTML = ""

        for (let year = currentYear; year <= MAX_YEAR; year++) {
          const option = document.createElement("option")
          option.value = year
          option.textContent = year
          els.year.appendChild(option)
        }

        // Set the selected year after populating
        els.year.value = view.getFullYear()
      }

      function populateVenueSelector() {
        const venues = ["Dar-ul-Khaas", "Aroos-ul-Bahar", "Grand Marquee"]

        els.evVenue.innerHTML = ""

        venues.forEach((venue) => {
          const option = document.createElement("option")
          option.value = venue
          option.textContent = venue
          els.evVenue.appendChild(option)
        })
      }

      // Initial render
      loadEvents() // Load events from API first
      updateNavigationButtons()

      // Populate year selector and add change event
      populateYearSelector()
      populateVenueSelector()
      els.year.addEventListener("change", (e) => {
        const selectedYear = parseInt(e.target.value)
        view = new Date(selectedYear, view.getMonth(), 1)
        render()
        updateNavigationButtons()
      })
    </script>
  </body>
</html>
